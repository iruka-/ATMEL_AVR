<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja">

<head>
 <meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8" />
 <title>FM3 - PukiWiki</title>

<!---
 <link rel="stylesheet" media="screen and (max-width:768px)" href="../skin/180wiki-sp.css" />

 --->

 <link rel="stylesheet" media="screen and (max-width:768px)" href="../skin/monobook/mobile.css" />
 <link rel="stylesheet" media="screen and (min-width:769px)" href="../skin/monobook/monobook.css" />

 <link rel="stylesheet" type="text/css" media="print" href="../skin/monobook/monobook.print.css" />
 <link rel="alternate" type="application/rss+xml" title="RSS" href="./?cmd=rss" />

 <meta name="viewport" content="width=device-width, initial-scale=1.0">

</head>
<body>
<div id="globalWrapper">
 <div id="menubar">
<ul class="list1 list-indent1"><li><a href="/ATMEL_AVR/html/" title="FrontPage" class="link_page_passage">Ｔｏｐ</a></li></ul>
<hr class="full_hr" />
<p><a href="EF-BC-A8-EF-BC-A9-EF-BC-A4-EF-BD-81-EF-BD-93-EF-BD-90-EF-BD-98-.html" class="link_page_passage">ＨＩＤａｓｐｘ</a></p>
<ul class="list1 list-indent1"><li><a href="EF-BC-A4-EF-BD-8F-EF-BD-97-EF-BD-8E-EF-BC-AC-EF-BD-8F-EF-BD-81-EF-BD-84-.html" class="link_page_passage">ＤｏｗｎＬｏａｄ</a></li>
<li><a href="EF-BC-A8-EF-BC-A9-EF-BC-A4-EF-BD-81-EF-BD-93-EF-BD-90-E9-AB-98-E9-80-9F-E5-8C-96-.html" class="link_page_passage">ＨＩＤａｓｐ高速化</a></li>
<li><strong><a href="Newest.html" title="Newest" class="link_page_passage">開発日記</a></strong> <a href="SiteMap.html" title="SiteMap" class="link_page_passage">ログ</a></li></ul>
<p><a href="E5-88-B6-E4-BD-9C-.html" class="link_page_passage">制作</a></p>
<p><a href="AVRetc.html" title="AVRetc" class="link_page_passage">ＡＶＲ関係</a></p>
<ul class="list1 list-indent1"><li><a href="AVR_Monit.html" class="link_page_passage">AVR_Monit</a></li>
<li><a href="AVR_term.html" class="link_page_passage">AVR_term</a></li>
<li><a href="W32_term.html" class="link_page_passage">W32_term</a></li>
<li><a href="HIDmon88.html" class="link_page_passage">HIDmon88</a></li>
<li><a href="HIDtester.html" class="link_page_passage">HIDtester</a></li>
<li><a href="usbRS232.html" class="link_page_passage">usbRS232</a></li>
<li><a href="Arduino2313.html" class="link_page_passage">Arduino2313</a></li>
<li><a href="E3-83-87-E3-82-B8-E3-82-BF-E3-83-AB-E3-83-86-E3-82-B9-E3-82-BF-E3-83-BC-.html" class="link_page_passage">デジタルテスター</a></li>
<li><a href="ATmega88E7-94-9F-E6-B4-BB-.html" class="link_page_passage">ATmega88生活</a></li>
<li><a href="KeyBoardE3-83-9E-E3-83-8B-E3-82-A2-.html" class="link_page_passage">KeyBoardマニア</a></li>
<li><a href="KeyBoardE3-83-9E-E3-83-8B-E3-82-A2-II.html" class="link_page_passage">KeyBoardマニアII</a></li>
<li><a href="Arduino400.html" class="link_page_passage">Arduino400</a></li>
<li><a href="PICspx.html" title="PICspx" class="link_page_passage">PICライター</a></li>
<li><a href="hid_blaster.html" title="hid_blaster" class="link_page_passage">ARMライター</a></li>
<li><a href="E8-B5-A4-E5-A4-96-E7-B7-9A-E3-83-AA-E3-83-A2-E3-82-B3-E3-83-B3-.html" class="link_page_passage">赤外線リモコン</a></li></ul>
<p><a href="ARM.html" class="link_page_passage">ARM</a></p>
<ul class="list1 list-indent1"><li><a href="armon.html" title="armon" class="link_page_passage">STM32ブートローダー</a></li>
<li><a href="stm32f103.html" title="stm32f103" class="link_page_passage">STM8S-Discovery改造</a></li>
<li><a href="stm8s_blaster.html" title="stm8s_blaster" class="link_page_passage">STM8S-OpenOCDライター</a></li>
<li><a href="LPCXpresso.html" class="link_page_passage">LPCXpresso</a></li>
<li><a href="lpc2D-armon.html" title="lpc-armon" class="link_page_passage">LPC用ブートローダー</a></li>
<li><a href="LPCUSB.html" title="LPCUSB" class="link_page_passage">NXP用LPCUSB</a></li>
<li><a href="ARM7mon.html" title="ARM7mon" class="link_page_passage">NXP用ブートローダー</a></li>
<li><a href="LPC1114.html" title="LPC1114" class="link_page_passage">MARY基板</a></li>
<li><a href="LPC1114FN28.html" class="link_page_passage">LPC1114FN28</a></li>
<li><a href="arm_blaster.html" title="arm_blaster" class="link_page_passage">OpenOCD　JTAGアダプター</a></li>
<li><a href="openocd2D-build.html" title="openocd-build" class="link_page_passage">OpenOCDビルド方法</a></li>
<li><a href="arm2D-gcc.html" title="arm-gcc" class="link_page_passage">arm-gccビルド方法</a></li>
<li><a href="mapleIDE.html" title="mapleIDE" class="link_page_passage">mapleIDEの改造</a></li>
<li><a href="libmapleE3-81-A7-E4-BB-AE-E6-83-B3-COM.html" class="link_page_passage">libmapleで仮想COM</a></li></ul>
<p>PIC32</p>
<ul class="list1 list-indent1"><li><a href="PIC32MX.html" class="link_page_passage">PIC32MX</a></li>
<li><a href="Pinguino.html" title="Pinguino" class="link_page_passage">Pinguinoで遊ぼう</a></li>
<li><a href="HIDBootX.html" title="HIDBootX" class="link_page_passage">ブートローダーを作る</a></li>
<li><a href="uartflash32.html" title="uartflash32" class="link_page_passage">シリアルブートローダー</a></li>
<li><a href="PIC32MX_USBCDC.html" title="PIC32MX_USBCDC" class="link_page_passage">USB仮想シリアル</a></li>
<li><a href="USB_CUSTOM.html" title="USB_CUSTOM" class="link_page_passage">USBカスタムデバイス</a></li>
<li><a href="PIC32mon.html" title="PIC32mon" class="link_page_passage">USB簡易モニター</a></li>
<li><a href="USBE3-82-AA-E3-82-B7-E3-83-AD-E3-82-B9-E3-82-B3-E3-83-BC-E3-83-97-.html" class="link_page_passage">USBオシロスコープ</a></li>
<li><a href="USB_HOST.html" title="USB_HOST" class="link_page_passage">USBホスト</a>　</li>
<li><a href="Bluetooth.html" title="Bluetooth" class="link_page_passage">PIC32でBluetooth</a>　</li>
<li><a href="USBAudio.html" class="link_page_passage">USBAudio</a>　</li>
<li><a href="USBStudy.html" class="link_page_passage">USBStudy</a>　</li>
<li><a href="pic32vga.html" title="pic32vga" class="link_page_passage">VGA出力に挑戦</a></li>
<li><a href="tinyBasic2.html" title="tinyBasic2" class="link_page_passage">BASICを動かす</a></li>
<li><a href="WinUSB.html" class="link_page_passage">WinUSB</a>　</li>
<li><a href="PIC32MXcust.html" title="PIC32MXcust" class="link_page_passage">勝手に改蔵*PIC32</a></li></ul>
<p>PIC18F</p>
<ul class="list1 list-indent1"><li><a href="pic18boot.html" title="pic18boot" class="link_page_passage">HIDブートローダー</a></li>
<li><a href="pic18spx.html" title="pic18spx" class="link_page_passage">AVR/PIC両用ライター</a></li>
<li><a href="pic18blaster.html" title="pic18blaster" class="link_page_passage">ARMライター</a></li>
<li><a href="pic18monit.html" title="pic18monit" class="link_page_passage">usb汎用クラス</a></li>
<li><a href="usbserial.html" title="usbserial" class="link_page_passage">usbシリアル変換</a></li>
<li><a href="pic18hidkey.html" title="pic18hidkey" class="link_page_passage">usbキーボード変換</a></li>
<li><a href="sdcc.html" title="sdcc" class="link_page_passage">sdccを使いこなす</a></li>
<li><a href="mcc18.html" title="mcc18" class="link_page_passage">mcc18を使いこなす</a></li>
<li><a href="HIDmon2D-2550.html" class="link_page_passage">HIDmon-2550</a></li>
<li><a href="HIDmon2D-14K50.html" class="link_page_passage">HIDmon-14K50</a></li>
<li><a href="PICmonitor.html" class="link_page_passage">PICmonitor</a></li></ul>
<p>試行錯誤の記録</p>
<ul class="list1 list-indent1"><li><a href="UBW.html" title="UBW" class="link_page_passage">UBWを試す</a></li>
<li><a href="HIDboot.html" title="HIDboot" class="link_page_passage">旧HIDboot</a></li>
<li><a href="PIC18F2550.html" title="PIC18F2550" class="link_page_passage">PIC18F2550試用記</a></li>
<li><a href="PIC18F4550.html" title="PIC18F4550" class="link_page_passage">PIC18F4550試用記</a></li></ul>
<p>その他マイコン</p>
<ul class="list1 list-indent1"><li><a href="NEC78K.html" class="link_page_passage">NEC78K</a></li>
<li><a href="RX62N.html" class="link_page_passage">RX62N</a></li>
<li><a href="SH2A.html" class="link_page_passage">SH2A</a></li>
<li><a href="EF-BC-A8-EF-BC-98-.html" class="link_page_passage">Ｈ８</a></li>
<li><a href="" class="link_page_passage">FM3</a></li>
<li><a href="ubuntuXP.html" title="ubuntuXP" class="link_page_passage">XPからubuntuに乗り換え</a></li>
<li><a href="Android.html" class="link_page_passage">Android</a></li>
<li><a href="Xen2D-hypervisor.html" class="link_page_passage">Xen-hypervisor</a></li>
<li><a href="Windows8E3-82-AB-E3-82-B9-E3-82-BF-E3-83-9E-E3-82-A4-E3-82-BA-.html" class="link_page_passage">Windows8カスタマイズ</a></li></ul>
<p>開発日記</p>
<ul class="list1 list-indent1"><li><a href="20152D-04.html" class="link_page_passage">2015-04</a></li></ul>
<hr class="full_hr" />
<p>ノウハウ</p>
<ul class="list1 list-indent1"><li><a href="AVRUSB_Tips.html" class="link_page_passage">AVRUSB_Tips</a></li>
<li><a href="EF-BC-A8-EF-BC-A9-EF-BC-A4-EF-BD-81-EF-BD-93-EF-BD-90-E6-83-85-E5-A0-B1-.html" class="link_page_passage">ＨＩＤａｓｐ情報</a></li>
<li><a href="E6-B1-8E-E7-94-A8-EF-BC-B5-EF-BC-B3-EF-BC-A2-2D-EF-BC-A9-EF-BC-AF-.html" class="link_page_passage">汎用ＵＳＢ-ＩＯ</a></li></ul>
<hr class="full_hr" />
<p>・<a href="AVRlink.html" title="AVRlink" class="link_page_passage">リンク</a></p>
<p>フリースペース</p>
<ul class="list1 list-indent1"><li><a href="/ATMEL_AVR/cgi-bin/note/index.cgi" rel="nofollow">ゲストブック</a></li></ul>
<hr class="full_hr" />
<p><a href="EF-BC-B7-EF-BD-89-EF-BD-84-EF-BD-85-EF-BC-B4-EF-BD-85-EF-BD-98-EF-BD-94-.html" title="ＷｉｄｅＴｅｘｔ" class="link_page_passage">旧コンテンツ</a><br />
<a href="EF-BC-B7-EF-BD-89-EF-BD-8E-EF-BC-B6-EF-BD-89-EF-BD-93-EF-BD-94-EF-BD-81-.html" class="link_page_passage">ＷｉｎＶｉｓｔａ</a><br />
<a href="E3-82-A4-E3-83-B3-E3-82-BF-E3-83-BC-E3-83-95-E3-82-A7-E3-83-BC-E3-82-B9-E8-80-83-.html" class="link_page_passage">インターフェース考</a></p>
<hr class="full_hr" />
<h5>最新の20件</h5>
<div><strong>2024-10-18</strong>
<ul class="recent_list">
 <li><a href="20222D-08.html" class="link_page_passage">2022-08</a></li>
</ul>
<strong>2024-10-11</strong>
<ul class="recent_list">
 <li><a href="Poem/SCMP2.html" class="link_page_passage">Poem/SCMP2</a></li>
 <li><a href="Poem/Ollama.html" class="link_page_passage">Poem/Ollama</a></li>
 <li><a href="Newest.html" class="link_page_passage">Newest</a></li>
</ul>
<strong>2024-10-10</strong>
<ul class="recent_list">
 <li><a href="Poem/GitList.html" class="link_page_passage">Poem/GitList</a></li>
 <li><a href="Poem/Win11upg.html" class="link_page_passage">Poem/Win11upg</a></li>
 <li><a href="Poem/LXCUbuntu.html" class="link_page_passage">Poem/LXCUbuntu</a></li>
 <li><a href="Poem/JavaScriptBBS.html" class="link_page_passage">Poem/JavaScriptBBS</a></li>
 <li><a href="Poem/SourceCodeViewer.html" class="link_page_passage">Poem/SourceCodeViewer</a></li>
 <li><a href="Poem/mkCert.html" class="link_page_passage">Poem/mkCert</a></li>
 <li><a href="Poem/WebPush.html" class="link_page_passage">Poem/WebPush</a></li>
</ul>
<strong>2024-07-01</strong>
<ul class="recent_list">
 <li><a href="node.jsE3-81-AE-E5-85-A5-E3-82-8C-E6-96-B9-.html" class="link_page_passage">node.jsの入れ方</a></li>
</ul>
<strong>2024-06-29</strong>
<ul class="recent_list">
 <li><a href="20242D-07.html" class="link_page_passage">2024-07</a></li>
</ul>
<strong>2024-06-21</strong>
<ul class="recent_list">
 <li><a href="SMRE3-81-AA-HDDE3-83-99-E3-83-B3-E3-83-81-E3-83-9E-E3-83-BC-E3-82-AF-.html" class="link_page_passage">SMRなHDDベンチマーク</a></li>
 <li><a href="UEFI_Basic.html" class="link_page_passage">UEFI_Basic</a></li>
</ul>
<strong>2024-06-20</strong>
<ul class="recent_list">
 <li><a href="MenuBar.html" class="link_page_passage">MenuBar</a></li>
</ul>
<strong>2022-12-06</strong>
<ul class="recent_list">
 <li><a href="MSE3-82-A2-E3-82-AB-E3-82-A6-E3-83-B3-E3-83-88-E3-81-AE-WindowsE3-81-AE-CE3-83-89-E3-83-A9-E3-82-A4-E3-83-96-E3-82-92-E4-BF-AE-E5-BE-A9-E3-81-99-E3-82-8B-.html" class="link_page_passage">MSアカウントのWindowsのCドライブを修復する</a></li>
</ul>
<strong>2022-09-29</strong>
<ul class="recent_list">
 <li><a href="AndroidE3-81-AB-SSLE8-87-AA-E5-B7-B1-E7-BD-B2-E5-90-8D-E8-A8-BC-E6-98-8E-E6-9B-B8-E3-82-92-E5-85-A5-E3-82-8C-E3-82-8B-.html" class="link_page_passage">AndroidにSSL自己署名証明書を入れる</a></li>
</ul>
<strong>2022-08-31</strong>
<ul class="recent_list">
 <li><a href="E7-B0-A1-E6-98-93-E9-80-9F-E5-BA-A6-E6-B8-AC-E5-AE-9A-E3-82-B5-E3-82-A4-E3-83-88-.html" class="link_page_passage">簡易速度測定サイト</a></li>
 <li><a href="E3-83-8D-E3-83-83-E3-83-88-E3-83-AF-E3-83-BC-E3-82-AF-BOOT.html" class="link_page_passage">ネットワークBOOT</a></li>
</ul>
</div>
</div>
 <div id="mainColumnWrapper">
  <div id="main-column">
   <div id="navigator"><ul><li class="selected" id="separate"><a href="">本文</a></li><li><a href="./?cmd=edit&amp;page=FM3">編集</a></li><li><a href="./?cmd=diff&amp;page=FM3">差分</a></li></ul></div>
   <div id="content">
    <h1 class="firstHeading">FM3</h1><div id="contentSub"></div>
    <p><a href="20122D-04.html" class="link_page_passage">2012-04</a></p>
<h2 id="content_1_0">FM3付録基板<a class="anchor_super" id="l263a378" href="#l263a378" title="l263a378" style="user-select:none;">&dagger;</a></h2>
<p><a href="/ATMEL_AVR/jpg/FM3img.jpg" rel="nofollow"><img src="/ATMEL_AVR/jpg/FM3img.jpg" alt="/ATMEL_AVR/jpg/FM3img.jpg" /></a></p>
<p>とりあえず</p>
<ul class="list1 list-indent1"><li><a href="armon.html" title="armon" class="link_page_passage">armon/armboot</a>（のUSBカスタムデバイス版）を移植してみる。</li></ul>
<p><br /></p>
<hr class="full_hr" />

<div class="jumpmenu"><a href="#navigator">&uarr;</a></div><h2 id="content_1_1">ＦＭ３開発環境の入手（gcc)<a class="anchor_super" id="p2bda83a" href="#p2bda83a" title="p2bda83a" style="user-select:none;">&dagger;</a></h2>
<ul class="list1 list-indent1"><li>Maple IDE に 安定版（おすすめ）の CodeSourcery G++ Liteが含まれています</li>
<li>下記ページから</li></ul>
<p><br /></p>
<ul class="list2 list-indent2"><li><a href="http://leaflabs.com/docs/maple-ide-install.html" rel="nofollow">http://leaflabs.com/docs/maple-ide-install.html</a>
<pre>Download¶
------------------
 Choose the correct version for your operating system:
 Platform Status 
 Windows XP Tested on 32-bit Windows XP 
 ~~~~~~~~~~</pre></li></ul>
<ul class="list1 list-indent1"><li>をクリックして、maple-ide-0.0.12-windowsxp32.zip をダウンロードします。</li>
<li>OS環境がWindowsでない場合は、適宜それぞれのバイナリーを入手してください。</li></ul>

<div class="jumpmenu"><a href="#navigator">&uarr;</a></div><h4 id="content_1_2">入手したら、（例えば）D:\ドライブ直下に展開します。<a class="anchor_super" id="o6cfcd3a" href="#o6cfcd3a" title="o6cfcd3a" style="user-select:none;">&dagger;</a></h4>

<ul class="list1 list-indent1"><li>そうすると、以下のディレクトリにgccの実行ファイル(arm-none-eabi-gcc.exeなど)が出来ます。
<pre>D:\maple-ide-0.0.12-windowsxp32\hardware\tools\arm\bin\</pre></li>
<li>そのディレクトリに実行パスを通します。
<pre>D:\&gt; path D:\maple-ide-0.0.12-windowsxp32\hardware\tools\arm\bin;%PATH%
     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</pre></li>
<li>実行パスの通し方は、コントロールパネル-&gt;システム-&gt;詳細設定-&gt;環境変数　を選んで、ユーザーの環境変数PATH
を新規に作成して、値を
<pre>D:\maple-ide-0.0.12-windowsxp32\hardware\tools\arm\bin</pre></li>
<li>にするか、上記の下線部を書いた短いファイル名のバッチファイルを、すでに実行パスが通っている場所に置いて、DOSプロンプトを開いた後で実行するか、どちらでもＯＫです。</li></ul>
<hr class="full_hr" />

<div class="jumpmenu"><a href="#navigator">&uarr;</a></div><h2 id="content_1_3">ＦＭ３開発環境でのコンパイルのしかた。<a class="anchor_super" id="oa49ae5c" href="#oa49ae5c" title="oa49ae5c" style="user-select:none;">&dagger;</a></h2>
<ul class="list1 list-indent1"><li>下記の<a href="/ATMEL_AVR/upload/STM/fm3vcom.zip" rel="nofollow">fm3vcom.zip</a>を入手して、同じようにD:\ドライブ直下に展開してください。</li>
<li>そしてDOSプロンプトから、該当のディレクトリに移動します。
<pre>D:&gt; cd \fm3vcom\src
D:&gt; cs-make</pre></li>
<li>cs-makeでは、最初に .dep/ ディレクトリが無いというエラーが出る場合がありますので、そのときは、
<pre>D:&gt; cd \fm3vcom\src
D:&gt; mkdir .dep
D:&gt; cs-make</pre></li>
<li>という風に .depという名前の依存ファイル用のテンポラリディレクトリを用意しておくとうまくいきます。</li>
<li>cs-make以外の、普通のGNU make( MinGWやWinAVRなどに付属のもの)では .depは自動作成されるようです。</li></ul>
<p><br />
<br />
<br />
<br /></p>
<hr class="full_hr" />

<div class="jumpmenu"><a href="#navigator">&uarr;</a></div><h2 id="content_1_4">USBカスタムファーム・ダウンロード<a class="anchor_super" id="reb3bd68" href="#reb3bd68" title="reb3bd68" style="user-select:none;">&dagger;</a></h2>
<p>これは、FM3基板をUSBカスタム(BULK)デバイスにしてしまうファームウェアです</p>
<p>ファームウェア(16kB)、Windows用クライアント(コマンドラインツール)、ソースファイル一式</p>
<ul class="list1 list-indent1"><li><a href="/ATMEL_AVR/upload/FM3/armboot.zip" rel="nofollow">armboot.zip</a></li></ul>
<p><br /></p>
<ul class="list1 list-indent1"><li>急ごしらえなので、微妙にだめなところも残っています。
<ul class="list2 list-indent1"><li><del>例えば、printfの結果をPCに転送する処理がバルク転送対応出来ていないのでuser関数のprintとか動きません。</del> ---動いているみたいです。</li></ul></li></ul>
<ul class="list1 list-indent1"><li>なぜかarmboot.exeまで動いています。<strong>不思議。</strong>３時間のやっつけ仕事なのに・・・</li></ul>
<ul class="list1 list-indent1"><li>コマンドラインツールの実行例です。
<pre>E:\armboot\src&gt;armon
TARGET DEV_ID=f3 VER=1.1(Bootloader) FLASH USED=7560,TOTAL=100000
ARM&gt; d
00000000 00 ff 00 20 5d 03 00 00  01 02 00 00 05 02 00 00
00000010 09 02 00 00 0d 02 00 00  11 02 00 00 15 02 00 00
00000020 19 02 00 00 1d 02 00 00  21 02 00 00 25 02 00 00
00000030 29 02 00 00 2d 02 00 00  31 02 00 00 35 02 00 00
00000040 39 02 00 00 3d 02 00 00  41 02 00 00 45 02 00 00
00000050 49 02 00 00 4d 02 00 00  51 02 00 00 55 02 00 00
00000060 59 02 00 00 5d 02 00 00  61 02 00 00 65 02 00 00
00000070 69 02 00 00 6d 02 00 00  71 02 00 00 75 02 00 00
ARM&gt; l 35c
0000035c b508           push    {r3, lr}
0000035e 4b22           ldr     r3, [pc, #136]  ; r3 = #$1fff0238
00000360 4a22           ldr     r2, [pc, #136]  ; r2 = #$55aa0f00
00000362 6819           ldr     r1, [r3, #0]
00000364 4291           cmp     r1, r2
00000366 d10c           bne.n   $00000382
00000368 6858           ldr     r0, [r3, #4]
0000036a 3201           adds    r2, #1
0000036c 4290           cmp     r0, r2
0000036e d108           bne.n   $00000382
00000370 6899           ldr     r1, [r3, #8]
00000372 3201           adds    r2, #1
00000374 4291           cmp     r1, r2
00000376 d104           bne.n   $00000382
00000378 68d8           ldr     r0, [r3, #12]
0000037a 2100           movs    r1, #0
0000037c 6019           str     r1, [r3, #0]
0000037e 6843           ldr     r3, [r0, #4]
00000380 4798           blx     r3
00000382 2069           movs    r0, #105
ARM&gt; p
  FM3_GPIO.PDIR0(0x40033300)     0x03bf 00000011_10111111
  FM3_GPIO.PDIR1(0x40033304)     0xfffe 11111111_11111110
  FM3_GPIO.PDIR2(0x40033308)     0x03ff 00000011_11111111
  FM3_GPIO.PDIR3(0x4003330c)     0xffff 11111111_11111111
  FM3_GPIO.PDOR0(0x40033400)     0x0000 00000000_00000000
  FM3_GPIO.PDOR1(0x40033404)     0x0000 00000000_00000000
  FM3_GPIO.PDOR2(0x40033408)     0x0000 00000000_00000000
  FM3_GPIO.PDOR3(0x4003340c)     0x0000 00000000_00000000
ARM&gt; q
Bye.</pre></li>
<li>メモリーダンプ、逆アセンブル、ポート参照/変更など出来ます。</li></ul>
<hr class="full_hr" />

<div class="jumpmenu"><a href="#navigator">&uarr;</a></div><h4 id="content_1_5">コマンドラインツール：ブートローダーの使い方<a class="anchor_super" id="ga354e7f" href="#ga354e7f" title="ga354e7f" style="user-select:none;">&dagger;</a></h4>
<ul class="list1 list-indent1"><li>4000番地〜に作成したプログラム（HEXファイル）をFLASHに転送して実行する。
<pre>D:&gt; armboot -r FM3-4000.hex</pre></li></ul>
<p><br /></p>
<ul class="list1 list-indent1"><li>既に書き込み済みのプログラム(4000番地)を起動する。
<pre>D:&gt; armboot -r</pre></li>
<li>もしくは
<pre>D:&gt; armon
ARM&gt; boot 4000</pre></li>
<li>armonのコマンドでは、任意の番地から始まる(そこにvectorを置いている)ファームウェアを起動できます。</li>
<li>ただし、armbootで書き込むときは、ページ単位でEraseされますので、vectorの開始番地はFLASHのページ先頭に置かないと消されてしまう場合があります。</li></ul>
<div class="ie5"><table class="style_table" cellspacing="1" border="0"><tbody><tr><td class="style_td">FLASHのページ先頭アドレス</td><td class="style_td">サイズ</td></tr>
<tr><td class="style_td">0</td><td class="style_td">16kB</td></tr>
<tr><td class="style_td">0x4000</td><td class="style_td">16kB</td></tr>
<tr><td class="style_td">0x8000</td><td class="style_td">96kB</td></tr>
<tr><td class="style_td">0x20000</td><td class="style_td">128kB</td></tr>
<tr><td class="style_td">0x40000</td><td class="style_td">128kB</td></tr>
<tr><td class="style_td">0x60000</td><td class="style_td">128kB</td></tr>
<tr><td class="style_td">0x80000</td><td class="style_td">128kB</td></tr>
<tr><td class="style_td">0xa0000</td><td class="style_td">128kB</td></tr>
<tr><td class="style_td">0xc0000</td><td class="style_td">128kB</td></tr>
<tr><td class="style_td">0xe0000</td><td class="style_td">128kB</td></tr>
</tbody></table></div>
<p><br /></p>
<ul class="list1 list-indent1"><li>ブートローダーを4000番地あるいはそれ以外の番地から始まるようにビルドしたアプリケーションを試している場合であれば、ブートローダーとアプリケーションを互いにbootコマンドで行き来できます。
<pre>D:&gt; armon
TARGET DEV_ID=f3 VER=1.1(Bootloader) FLASH USED=7560,TOTAL=100000
ARM&gt; boot 4000  ＜＝＝＝アプリケーションを起動する。
bye
D:&gt; armon
TARGET DEV_ID=f3 VER=1.1(Application) FLASH USED=7560,TOTAL=100000
ARM&gt; boot 0  ＜＝＝＝ブートローダーに戻る。
bye</pre></li></ul>
<p><br /></p>
<ul class="list1 list-indent1"><li>アプリケーションが起動している状態からでも、4000番地以降のアプリの書き換えが出来ます。
<pre>D:&gt; armboot -r FM3-4000.hex</pre></li>
<li>これは、実際には内部的にboot 0 を実行した後、USB再接続して4000番地〜のFLASH書き換えと実行を行ないます。</li>
<li>ただし、アプリケーションはブートローダーと同じプロトコルを解するUSBカスタムデバイスの機能を持っている必要があります。（単に番地を変えてビルドするだけで可能です。）</li></ul>
<p><br /></p>

<div class="jumpmenu"><a href="#navigator">&uarr;</a></div><h4 id="content_1_6">Linuxでの使用<a class="anchor_super" id="wbe64e4b" href="#wbe64e4b" title="wbe64e4b" style="user-select:none;">&dagger;</a></h4>
<ul class="list1 list-indent1"><li>ファームウェアはLinux上でも普通にビルドできます。</li>
<li>FLASH USB Direct ProgrammerはWindows版しか提供されていないため、WindowsかWineのようなもので焼きこむしかありません。</li>
<li>Windows側コマンドラインツールは、そのままLinuxでビルドできます。(libusb-devなどを導入する必要があります）</li>
<li>armon/armbootを実行する場合はusbデバイスのアクセス権が必要です。
<ul class="list2 list-indent1"><li>root権限で、/etc/udev/rules.d/95-my-permissions.rules に以下の内容を書き込むか、あるいは直接rootユーザーでarmon/armbootを起動してください。</li></ul></li></ul>
<pre>SUBSYSTEM==&quot;usb&quot;,SYSFS{idVendor}==&quot;04c5&quot;,SYSFS{idProduct}==&quot;4242&quot;,MODE=&quot;0666&quot;</pre>
<pre>$ sudo /etc/init.d/udev restart</pre>
<ul class="list1 list-indent1"><li>実在Linuxでない場合、たとえばVMWarePlayer内のLinuxからはアクセスがうまくいきませんが今のところ原因は分かっていません。</li></ul>
<p><br /></p>

<div class="jumpmenu"><a href="#navigator">&uarr;</a></div><h4 id="content_1_7">残念なお知らせ。<a class="anchor_super" id="h0b5ca6c" href="#h0b5ca6c" title="h0b5ca6c" style="user-select:none;">&dagger;</a></h4>
<ul class="list1 list-indent1"><li>VectorTableのベースアドレスを設定するVTORレジスタの存在を見落としていました。</li>
<li><del>VTORを使用するように修正すれば、上記r2,r3破壊問題は簡単に解決します。</del></li>
<li><del>ついでにブートローダーのコードサイズは512byte以上縮めることも可能です。</del> ---処置しました。</li></ul>
<p>VectorTableのベースアドレスを設定するレジスタはてっきりNVIC内にあるものだと思い込んでいました。</p>
<p><br />
<br />
<br /></p>
<hr class="full_hr" />

<div class="jumpmenu"><a href="#navigator">&uarr;</a></div><h2 id="content_1_8">その２：仮想ＣＯＭポート作成サンプル<a class="anchor_super" id="bfa2c193" href="#bfa2c193" title="bfa2c193" style="user-select:none;">&dagger;</a></h2>
<p>ダウンロード</p>
<ul class="list1 list-indent1"><li><a href="/ATMEL_AVR/upload/STM/fm3vcom.zip" rel="nofollow">fm3vcom.zip</a></li></ul>
<ul class="list1 list-indent1"><li>これも急ごしらえです。</li>
<li><del>（いろいろブートローダー系のコードが残ったままです。）</del>--修正済み</li></ul>
<ul class="list1 list-indent1"><li>富士通謹製のサンプル mb9bf506r-usbfunc-msc-v11.zip （ＭＳＣデバイス）を基に作成しています。</li></ul>
<p><br />
<br />
<br />
<br /></p>
<hr class="full_hr" />

<div class="jumpmenu"><a href="#navigator">&uarr;</a></div><h2 id="content_1_9">その３：FM3でprintfを使ってみる<a class="anchor_super" id="q1077e6c" href="#q1077e6c" title="q1077e6c" style="user-select:none;">&dagger;</a></h2>
<p>上記のFM3カスタムファームウェアを使用します。</p>
<p>ファームウェア(16kB)、Windows用クライアント(コマンドラインツール)、ソースファイル一式</p>
<ul class="list1 list-indent1"><li><a href="/ATMEL_AVR/upload/FM3/armboot.zip" rel="nofollow">armboot.zip</a></li></ul>
<ul class="list1 list-indent1"><li>上記zipファイルを D:\ に展開します。</li>
<li>armboot/src/FM3-0000.hex を GUIの「USB Direct Programmer」(富士通サイトから入手)により焼きこみます。</li>
<li>BOOTジャンパーをoffにして、リセットします。</li>
<li>armboot/monitor/armon.exe を起動して、FM3基板に接続できることを確認しておきます。</li>
<li>mapleIDEをダウンロードして、ARM用gccが使えるようにしておいてください。</li></ul>
<ul class="list1 list-indent1"><li>では、ビルドを行なってみます。
<pre>D:\armboot\src\&gt; cs-make   　　（もしくは MinGWをインストールしているなら make）
D:\armboot\src\&gt; w.bat         （FM3-4000.hex をブートローダー経由でFM3基板に書き込んで、即実行します）

D:\armboot\src\&gt; a.bat         （armon.exeを起動して、script というテキストファイルに書かれた処理を実行します）
D:\armboot\src\&gt;..\monitor\armon.exe -i script
TARGET DEV_ID=f3 VER=1.1(Application) FLASH USED=106b0,TOTAL=10000
ARM&gt; user
* Start Program
Hello World
Hello : !&quot;#$%&amp;'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQ
Hello : !&quot;#$%&amp;'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQ
p=0x1fff9120
q=0x1fff9528
sin(                0 ) =                0
sin(         0.628319 ) =         0.587785
sin(          1.25664 ) =         0.951057
・・・</pre></li></ul>
<ul class="list1 list-indent1"><li>printfを行なっているプログラムは、armboot/src/monitor/usercmd.c にあります。</li></ul>
<ul class="list1 list-indent1"><li>I/Oポートのコントロールは pinMode(),digitalRead(),digitalWrite()という関数が用意されているので、
それらを呼び出すことで簡単な処理を書くことも出来ます。</li></ul>
<ul class="list1 list-indent1"><li>make , w.bat (FLASH書き込み) , a.bat (armonによるユーザー関数の実行) を一連に実行するようなバッチファイル
を用意することで、Arduino風（プログラムを書き換えて即実行）のコマンドラインな開発が出来ます。</li></ul>
<p><br />
<br />
<br />
<br /></p>
<hr class="full_hr" />

<div class="jumpmenu"><a href="#navigator">&uarr;</a></div><h2 id="content_1_10">予定稿１：Ｌチカサンプルを書いてみる？<a class="anchor_super" id="hb1c93fa" href="#hb1c93fa" title="hb1c93fa" style="user-select:none;">&dagger;</a></h2>
<ul class="list1 list-indent1"><li>USBファンクションを取り去った状態で、Arduinoっぽい関数(digitalWriteなど)を実装して、最小限のLEDブリンクを書いてみました。</li></ul>
<p>ダウンロード</p>
<ul class="list1 list-indent1"><li><a href="/ATMEL_AVR/upload/FM3/led.zip" rel="nofollow">led.zip</a></li></ul>
<ul class="list1 list-indent1"><li>KEILとかIARの環境では、startupがアセンブリで書かれていて融通が利かないため、ここをＣ言語（crt0.c）で書いてメンテしやすくしております。</li>
<li>ビルドには、gcc ( CodeSourcery G++ Lite を推奨 ) とmakeを使用します。</li></ul>
<p><br />
<br />
<br />
<br /></p>
<hr class="full_hr" />

<div class="jumpmenu"><a href="#navigator">&uarr;</a></div><h2 id="content_1_11">予定稿２：VGA出力テスト。<a class="anchor_super" id="h1341101" href="#h1341101" title="h1341101" style="user-select:none;">&dagger;</a></h2>
<ul class="list1 list-indent1"><li>はたして気力が続くかどうか・・・</li></ul>
<p>？？？</p>
<p><br />
<br />
<br />
<br /></p>
<hr class="full_hr" />

<div class="jumpmenu"><a href="#navigator">&uarr;</a></div><h2 id="content_1_12">以下、雑談<a class="anchor_super" id="c363f8d9" href="#c363f8d9" title="c363f8d9" style="user-select:none;">&dagger;</a></h2>
<ul class="list1 list-indent1"><li>せっかくFujitsuなので、FM8とかFM7のエミュレータを動かしてみたいのだけれど、バイナリー持ってません。</li>
<li>当時のMZ-****とかPC-8***とかのバイナリーもほとんど持ってないです。</li></ul>
<ul class="list1 list-indent1"><li>バイナリー持っていたとして、エミュを書いたとしても、BIOS ROMの抜き取りするためには<strong>どうしても実機が必要になります。</strong></li></ul>
<p>そういうわけでエミュ遊びはおあずけです。</p>
<p><br />
せっかくだから<a href="http://www.lua.org/" rel="nofollow">Lua</a>とか<a href="http://www.gnu.org/software/gforth/" rel="nofollow">gforce</a>とか動かしてみようかなとか思ったのですが、</p>
<ul class="list1 list-indent1"><li>LuaはWindows版がうまく使いこなせなかったのでパス。（もともとPascal好きじゃないし）</li>
<li>Forthは昔やってたけれど、やっぱり人間が読むコードじゃない感じなのでパス。（実行速度は速いんだけどねぇ・・・）</li>
<li>文法的にはC言語に良く似ていて、内部的にはForthインタプリタの <a href="http://www.s-lang.org/" rel="nofollow">slang</a> あたりが一番良いのかなぁ・・・とっつきやすさ的には。</li></ul>
<p><br />
<br />
<br /></p>
<hr class="full_hr" />

<div class="jumpmenu"><a href="#navigator">&uarr;</a></div><h2 id="content_1_13">参考リンク<a class="anchor_super" id="n189cbc5" href="#n189cbc5" title="n189cbc5" style="user-select:none;">&dagger;</a></h2>
<p>電子工作マスターへの歩み jujurouさん</p>
<ul class="list1 list-indent1"><li><a href="http://jujurou.blog34.fc2.com/" rel="nofollow">http://jujurou.blog34.fc2.com/</a></li></ul>
<p><br />
流石、対応速いです。</p>
<p><br />
<br />
<br />
独り言：</p>
<ul class="list1 list-indent1"><li>こちらでも、一応1MB Flash対応のflash/nor/fm3.cは書いてみました。（つもり）</li>
<li>だけど、この石、USB bootloaderのROMが載っているので、OpenOCDは要らないのでした。</li>
<li>armon/armbootのブートローダーでごちゃごちゃやってます。(NXP用語で言うところのISP/IAP (In Application Programing)ってやつ)</li></ul>
   </div>
  </div>
 </div>
 <div style="clear:both;height:1em;"></div>
 <div id="logo"><a href="/ATMEL_AVR/html/" style="background-image: url(image/title.jpg);"></a></div>
 <div id="personal"><ul><li class="login"><a href="http://">ログインまたはアカウント作成</a></li></ul></div>
 <div id="footer">
  <div id="f-officialico">
   <a href="http://pukiwiki.sourceforge.jp/"><img src="../image/b_pukiwiki.official.png" alt="PukiWiki-official" /></a>
  </div>
  <div id="f-officialdevico">
   <a href="http://pukiwiki.sourceforge.jp/dev/"><img src="../image/b_pukiwiki.dev.png" alt="PukiWiki-dev" /></a>
  </div>
  <div id="f-list">
   <ul><li id="lastmod">Last-modified: 2014-11-17 (月) 14:44:26<span class="page_passage" data-mtime="2014-11-17T14:44:26+09:00"></span></li><li>Site admin: <a href="http://pukiwiki.example.com/">anonymous</a></li>    <li>Powered by PukiWiki</li>
    <li><a href="http://www.luntf.com/">Monobook for PukiWiki</a></li>
   </ul>
  </div>
  <div style="clear:both;"></div>
 </div>
</div>
</body>
</html>
